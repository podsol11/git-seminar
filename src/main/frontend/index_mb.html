<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoinformationsdienste: DB-Haltestellen</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="shortcut icon" href="#"> <!-- wegen favicon.ico error. ggf. entfernen-->
    <link href="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.min.css" rel="stylesheet" />
    <link href="mapstyle.css" rel="stylesheet" type="text/css" />
    <script src="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.js"></script>


</head>
<body>
    <div id='map'></div>


        <input type="checkbox" id="switchbutton" class="checkbox" />
        <label for="switchbutton" class="toggle" id = "switchlabel">
              
            <p>OFF ON</p>
  
        </label>


    <div id = "params_div" class="absolute fl my24 mx24 py24 px24 bg-gray-faint round">
        <form id="params">
            <h4 class="txt-m txt-bold mb6">Verkehrsmittel:</h4>
            <div class="mb12 mr12 toggle-group align-center">
                <label class="toggle-container">
                    <input name="profile" type="radio" value="walking" />
                    <div class="toggle toggle--active-null toggle--null">zu Fu√ü</div>
                </label>
                <label class="toggle-container">
                    <input name="profile" type="radio" value="cycling" checked />
                    <div class="toggle toggle--active-null toggle--null">Fahrrad</div>
                </label>
                <label class="toggle-container">
                    <input name="profile" type="radio" value="driving" />
                    <div class="toggle toggle--active-null toggle--null">PKW</div>
                </label>
            </div>
            <h4 class="txt-m txt-bold mb6">Maximale Dauer:</h4>
            <div class="mb12 mr12 toggle-group align-center">
                <label class="toggle-container">
                    <input name="duration" type="radio" value="10" checked />
                    <div class="toggle toggle--active-null toggle--null">10 min</div>
                </label>
                <label class="toggle-container">
                    <input name="duration" type="radio" value="20" />
                    <div class="toggle toggle--active-null toggle--null">20 min</div>
                </label>
                <label class="toggle-container">
                    <input name="duration" type="radio" value="30" />
                    <div class="toggle toggle--active-null toggle--null">30 min</div>
                </label>
            </div>
        </form>
    </div>
    <div class="tableFixHead" id="departure_table">
        <table>
          <thead>
            <tr>
              <th>Departures</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
</body>
</html>

<script src="api_request.js" type="text/javascript"></script>
<script>

const checkbox = document.getElementById('switchbutton');

mapboxgl.accessToken = 'pk.eyJ1IjoianV0bzQ4M2MiLCJhIjoiY2t1em0xbnZuMjk4ZTJvbzB1NTRqbjE3NCJ9._WokI9DVRVeKtbgVJVKo-A';

// retrieve "Verkehrsmittel" and "Maximale Dauer"
const params = document.getElementById('params');
const urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';

marker_list = [];
let profile = 'cycling';
let minutes = 10;


timetables = null;

const map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/mapbox/light-v10',
center: [13, 51],
zoom: 7,
doubleClickZoom: false
});


// All stops in Saxony with respective EVA-No
map.on('load', () => {
    map.addSource('haltestellen', {
        type: 'geojson',
        
        data: 'Data/haltestellen_wgs84.geojson'
    });
    
    map.addLayer({
        'id': 'haltestellen-layer',
        'type': 'circle',
        'source': 'haltestellen',
        'paint': {
            'circle-radius': 2,
            'circle-stroke-width': 2,
            'circle-color': 'red',
            'circle-stroke-color': 'white'
        }
    });
    
    // Add empty Source. Container for Isochrone polygon. Gets reset with every getIso()- call
    map.addSource('iso', {
    type: 'geojson',
    data: {
    'type': 'FeatureCollection',
    'features': []
    }
    });

    map.addLayer(
        {
        'id': 'isoLayer',
        'type': 'fill',
        'source': 'iso',
        'layout': {},
        'paint': {
        'fill-color': '#5a3fc0',
        'fill-opacity': 0.3
        
        }
    });


});


map.on('dblclick', function(click) {
    // get html collection of 'all' current markers
    let marker_div = document.getElementsByClassName("mapboxgl-marker mapboxgl-marker-anchor-center");
    
    // if there is a marker, delete marker div and marker object (from marker_list)
    if (marker_div.length > 0) {
        console.log(marker_div);
        marker_div[0].parentNode.removeChild(marker_div[0]);
        marker_list.pop();
    }

    let coordinates = click.lngLat;
    let marker = new mapboxgl.Marker({
        draggable : true,
        'color': '#314ccd'
    });
    marker.setLngLat(coordinates);
    marker.addTo(map);
    marker.on('dragend', onDragEnd);

    marker_list.push(marker);
    
    document.getElementById("params_div").style.display = "inline";

    getIso();
});




// query clicked trainstation feature and display name and api button in a popup
map.on('click', (event) => {
        
    let features = map.queryRenderedFeatures(event.point, {
        layers: ['haltestellen-layer'] 
    });
    
    if (!features.length) {
        return;
    }
    let feature = features[0];
    


    let popup = new mapboxgl.Popup({ offset: [0, -15] })
        .setLngLat(feature.geometry.coordinates)
        .setHTML(
            `<h3>${feature.properties.NAME}</h3>
            <button id='btn-gettimetable'>Fahrplan anfordern</button>`
        )
        .addTo(map);

        document.getElementById('btn-gettimetable')
        .addEventListener('click', function(){
            get_time_table(feature.properties.EVA_NR, 2);
        });
});


async function getIso() {
    let marker = marker_list[0];
    let lngLat = marker.getLngLat();
    let lng = lngLat.lng;
    let lat = lngLat.lat;

    let query = await fetch(
    `${urlBase}${profile}/${lng},${lat}?contours_minutes=${minutes}&polygons=true&access_token=${mapboxgl.accessToken}`,
    { method: 'GET' }
    );
    let data = await query.json();

    map.getSource('iso').setData(data);

    let = iso_polygon = data.features[0].geometry;
   
    map.setPaintProperty('haltestellen-layer', 'circle-radius', 
                        ["case", 
                        ["==", ["within", iso_polygon], true], 4, 
                        ["==", ["within", iso_polygon], false], 2, 
                        0]);


}

params.addEventListener('change', (event) => {
    if (event.target.name === 'profile') {
        profile = event.target.value;
    } else if (event.target.name === 'duration') {
        minutes = event.target.value;
    }
    getIso();
});

function onDragEnd() {
    getIso();
    console.log(timetables);
}




checkbox.addEventListener('change', (event) => {
  if (event.currentTarget.checked) {
    document.getElementById("params_div").style.display = "none";
    document.getElementById("departure_table").style.display = "none";
    document.getElementsByClassName("mapboxgl-marker mapboxgl-marker-anchor-center")[0].style.display = "none";
    map.setLayoutProperty("haltestellen-layer", 'visibility', 'none');
    map.setLayoutProperty("isoLayer", 'visibility', 'none');


  } else {
    document.getElementById("params_div").style.display = "inline";
    document.getElementById("departure_table").style.display = "inline";
    document.getElementsByClassName("mapboxgl-marker mapboxgl-marker-anchor-center")[0].style.display = "inline";
    map.setLayoutProperty("haltestellen-layer", 'visibility', 'visible');
    map.setLayoutProperty("isoLayer", 'visibility', 'visible');
  }
})


</script>