<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoinformationsdienste: DB-Haltestellen</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="shortcut icon" href="#"> <!-- wegen favicon.ico error. ggf. entfernen-->
    <link href="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.min.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
<style>
        body {
          margin: 0;
          padding: 0;
        }
  
        #map {
          position: absolute;
          top: 0;
          bottom: 0;
          width: 100%;
        }

        .mapboxgl-popup-close-button {
        display: none;
        }

        .mapboxgl-popup-content {
        font: 400 15px/22px 'Source Sans Pro', 'Helvetica Neue', sans-serif;
        padding: 0;
        width: 180px;
        }

        .mapboxgl-popup-content h3 {
        background: #91c949;
        color: #fff;
        margin: 0;
        padding: 10px;
        border-radius: 3px 3px 0 0;
        font-weight: 700;
        margin-top: -15px;
        }

        .mapboxgl-popup-content button {
        margin: 0;
        padding: 10px;
        font-weight: 400;
        }


      </style>
</head>
<body>
    <div id='map'></div>

    <div class="absolute fl my24 mx24 py24 px24 bg-gray-faint round">
        <form id="params">
            <h4 class="txt-m txt-bold mb6">Verkehrsmittel:</h4>
            <div class="mb12 mr12 toggle-group align-center">
                <label class="toggle-container">
                    <input name="profile" type="radio" value="walking" />
                    <div class="toggle toggle--active-null toggle--null">zu Fu√ü</div>
                </label>
                <label class="toggle-container">
                    <input name="profile" type="radio" value="cycling" checked />
                    <div class="toggle toggle--active-null toggle--null">Fahrrad</div>
                </label>
                <label class="toggle-container">
                    <input name="profile" type="radio" value="driving" />
                    <div class="toggle toggle--active-null toggle--null">PKW</div>
                </label>
            </div>
            <h4 class="txt-m txt-bold mb6">Maximale Dauer:</h4>
            <div class="mb12 mr12 toggle-group align-center">
                <label class="toggle-container">
                    <input name="duration" type="radio" value="10" checked />
                    <div class="toggle toggle--active-null toggle--null">10 min</div>
                </label>
                <label class="toggle-container">
                    <input name="duration" type="radio" value="20" />
                    <div class="toggle toggle--active-null toggle--null">20 min</div>
                </label>
                <label class="toggle-container">
                    <input name="duration" type="radio" value="30" />
                    <div class="toggle toggle--active-null toggle--null">30 min</div>
                </label>
            </div>
        </form>
    </div>
    
    


</body>
</html>

<script src="api_request.js" type="text/javascript"></script>
<script>

mapboxgl.accessToken = 'pk.eyJ1IjoianV0bzQ4M2MiLCJhIjoiY2t1em0xbnZuMjk4ZTJvbzB1NTRqbjE3NCJ9._WokI9DVRVeKtbgVJVKo-A';

const map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/mapbox/light-v10',
center: [13, 51],
zoom: 7
});

map.on('load', () => {
    map.addSource('haltestellen', {
        type: 'geojson',
        
        data: 'Data/haltestellen_wgs84.geojson'
    });
    
    map.addLayer({
        'id': 'haltestellen-layer',
        'type': 'circle',
        'source': 'haltestellen',
        'paint': {
            'circle-radius': 2,
            'circle-stroke-width': 2,
            'circle-color': 'red',
            'circle-stroke-color': 'white'
        }
    });

    map.addSource('iso', {
    type: 'geojson',
    data: {
    'type': 'FeatureCollection',
    'features': []
    }
    });

    map.addLayer(
        {
        'id': 'isoLayer',
        'type': 'fill',
        'source': 'iso',
        'layout': {},
        'paint': {
        'fill-color': '#5a3fc0',
        'fill-opacity': 0.3
        }
    });

    map.addSource('intersection', {
    type: 'geojson',
    data: {
        type: 'FeatureCollection',
        features: []
    }
});

// Initialize the marker at the query coordinates
marker.setLngLat(lngLat).addTo(map);

// Make the API call


marker.on('dragend', onDragEnd);



});

map.on('click', (event) => {
        
    let features = map.queryRenderedFeatures(event.point, {
        layers: ['haltestellen-layer'] 
    });
    
    if (!features.length) {
        return;
    }
    let feature = features[0];
    


    let popup = new mapboxgl.Popup({ offset: [0, -15] })
        .setLngLat(feature.geometry.coordinates)
        .setHTML(
            `<h3>${feature.properties.NAME}</h3>
            <button id='btn-gettimetable'>Fahrplan anfordern</button>`
        )
        .addTo(map);

        document.getElementById('btn-gettimetable')
        .addEventListener('click', function(){
            get_time_table(feature.properties.EVA_NR, '211115', '16');
            
    });


});

// Target the params form in the HTML
const params = document.getElementById('params');

// Create variables to use in getIso()
const urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';
let lon = 13.5040715;
let lat = 51.1411039;
let profile = 'cycling';
let minutes = 10;
let lngLat = {
    lon: lon,
    lat: lat
};

let marker = new mapboxgl.Marker({
    draggable : true,
    'color': '#314ccd'
});



function onDragEnd() {
    getIso();
    
}


// sets up the Isochrone API query then makes a fetch call
async function getIso() {

    let lngLat = marker.getLngLat();
    let lng = lngLat.lng;
    let lat = lngLat.lat;

    let query = await fetch(
    `${urlBase}${profile}/${lng},${lat}?contours_minutes=${minutes}&polygons=true&access_token=${mapboxgl.accessToken}`,
    { method: 'GET' }
    );
    let data = await query.json();

    map.getSource('iso').setData(data);

    let = iso_polygon = data.features[0].geometry;
   
    map.setPaintProperty('haltestellen-layer', 'circle-radius', ["case", ["==", ["within", iso_polygon], true], 4, ["==", ["within", iso_polygon], false], 2, 0]);

    // console.log(intersection);
}

// When a user changes the value of profile or duration by clicking a button, change the parameter's value and make the API query again
params.addEventListener('change', (event) => {
    if (event.target.name === 'profile') {
        profile = event.target.value;
    } else if (event.target.name === 'duration') {
        minutes = event.target.value;
    }
    getIso();
});


</script>